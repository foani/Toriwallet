# TORI 지갑 아키텍처 개요

## 1. 시스템 아키텍처

TORI 지갑은 모노레포(Monorepo) 구조를 기반으로 여러 플랫폼(브라우저 확장 프로그램, 모바일 앱, 데스크톱 앱, 텔레그램 미니앱)에서 일관된 경험을 제공하는 멀티체인 암호화폐 지갑입니다. 아키텍처는 코드 재사용성을 극대화하고 플랫폼별 특수성을 유지하는 방식으로 설계되었습니다.

### 1.1 모노레포 구조

TORI 지갑은 모노레포 구조로 설계되어 있으며, 다음과 같은 패키지로 구성됩니다:

```
tori-wallet/
├── packages/
│   ├── core/           # 공통 핵심 로직
│   ├── extension/      # 브라우저 확장 프로그램
│   ├── mobile/         # 모바일 앱 (React Native)
│   ├── desktop/        # 데스크톱 앱 (Electron)
│   └── telegram/       # 텔레그램 미니앱
├── shared/             # 공유 자원 (이미지, 다국어 등)
├── tools/              # 빌드 도구 및 스크립트
├── admin/              # 관리자 패널
├── tests/              # 통합 테스트
├── docs/               # 문서
├── security/           # 보안 감사 보고서
└── legal/              # 법적 문서
```

이 구조를 통해 핵심 로직을 한 번 구현하고 여러 플랫폼에서 재사용할 수 있으며, 플랫폼별 특수성은 각 패키지에서 개별적으로 구현할 수 있습니다.

### 1.2 핵심 패키지 (Core)

Core 패키지는 지갑의 핵심 기능을 구현한 패키지로, 다른 모든 패키지에서 공통적으로 사용됩니다. 주요 기능은 다음과 같습니다:

- 지갑 생성 및 관리
- 암호화 및 서명
- 트랜잭션 생성 및 서명
- 네트워크 연결 및 관리
- 자산 관리
- 스테이킹 및 DeFi
- 크로스체인 기능
- 보안 기능

Core 패키지는 다음과 같은 디렉토리 구조로 구성됩니다:

```
core/
├── src/
│   ├── constants/      # 상수 및 설정
│   ├── services/       # 핵심 서비스
│   ├── utils/          # 유틸리티 함수
│   ├── hooks/          # React 훅
│   ├── contexts/       # React 컨텍스트
│   └── types/          # 타입 정의
```

### 1.3 브라우저 확장 프로그램

브라우저 확장 프로그램은 Chrome, Firefox 등의 브라우저에서 동작하는 지갑 확장 프로그램입니다. 확장 프로그램은 다음과 같은 주요 컴포넌트로 구성됩니다:

- **백그라운드 스크립트**: 지갑의 핵심 로직을 구현하고 브라우저 API와 통신
- **콘텐츠 스크립트**: 웹페이지와 확장 프로그램 간의 통신을 담당
- **인페이지 스크립트**: 웹페이지에 주입되어 Web3 공급자 역할 수행
- **팝업 UI**: 사용자 인터페이스

확장 프로그램은 다음과 같은 디렉토리 구조로 구성됩니다:

```
extension/
├── public/             # 정적 파일 및 매니페스트
├── src/
│   ├── background/     # 백그라운드 스크립트
│   ├── contentScript/  # 콘텐츠 스크립트
│   ├── inpage/         # 인페이지 스크립트
│   ├── popup/          # 팝업 UI
│   └── dapp/           # dApp 브라우저
```

### 1.4 모바일 앱

모바일 앱은 React Native를 사용하여 iOS 및 Android 플랫폼에서 동작하는 지갑 앱입니다. 주요 기능은 다음과 같습니다:

- 지갑 생성 및 관리
- 자산 관리 및 트랜잭션
- QR 코드 스캔 및 생성
- 생체 인증
- 푸시 알림
- dApp 브라우저
- 스테이킹 및 DeFi
- 크로스체인 기능

모바일 앱은 다음과 같은 디렉토리 구조로 구성됩니다:

```
mobile/
├── android/            # Android 네이티브 코드
├── ios/                # iOS 네이티브 코드
├── src/
│   ├── components/     # UI 컴포넌트
│   ├── screens/        # 화면 컴포넌트
│   ├── navigation/     # 내비게이션 설정
│   ├── biometrics/     # 생체 인증
│   └── styles/         # 스타일 및 테마
```

### 1.5 데스크톱 앱

데스크톱 앱은 Electron을 사용하여 Windows, macOS, Linux 플랫폼에서 동작하는 지갑 앱입니다. 주요 기능은 다음과 같습니다:

- 지갑 생성 및 관리
- 자산 관리 및 트랜잭션
- 고급 분석 도구
- dApp 브라우저
- 스테이킹 및 DeFi
- 크로스체인 기능

데스크톱 앱은 다음과 같은 디렉토리 구조로 구성됩니다:

```
desktop/
├── src/
│   ├── main/           # Electron 메인 프로세스
│   ├── preload/        # 프리로드 스크립트
│   └── renderer/       # 렌더러 프로세스 (UI)
```

### 1.6 텔레그램 미니앱

텔레그램 미니앱은 텔레그램 메신저 내에서 동작하는 지갑 앱입니다. 주요 기능은 다음과 같습니다:

- 지갑 생성 및 관리
- 자산 관리 및 트랜잭션
- 텔레그램 사용자 간 P2P 송금
- 텔레그램 결제 시스템 통합

텔레그램 미니앱은 다음과 같은 디렉토리 구조로 구성됩니다:

```
telegram/
├── src/
│   ├── components/     # UI 컴포넌트
│   ├── pages/          # 페이지 컴포넌트
│   └── telegram-api/   # 텔레그램 API 래퍼
```

### 1.7 관리자 패널

관리자 패널은 지갑 시스템을 관리하고 모니터링하기 위한 웹 애플리케이션입니다. 주요 기능은 다음과 같습니다:

- 사용자 관리
- 네트워크 관리
- 분석 및 통계
- 로그 및 모니터링
- 시스템 설정

관리자 패널은 다음과 같은 디렉토리 구조로 구성됩니다:

```
admin/
├── src/
│   ├── components/     # UI 컴포넌트
│   ├── pages/          # 페이지 컴포넌트
│   └── services/       # API 서비스
```

## 2. 데이터 흐름

TORI 지갑의 데이터 흐름은 다음과 같은 패턴을 따릅니다:

### 2.1 지갑 생성 및 복구 프로세스

1. 사용자가 지갑 생성 또는 복구 요청
2. Core 패키지의 keyring 서비스가 니모닉 생성 또는 복구
3. HD 키 파생을 통해 개인 키 및 공개 키 생성
4. 개인 키는 암호화되어 안전하게 저장
5. 지갑 정보 저장 및 UI 업데이트

### 2.2 트랜잭션 프로세스

1. 사용자가 트랜잭션 요청 (자산 전송, 스마트 계약 호출 등)
2. 트랜잭션 빌더가 트랜잭션 객체 생성
3. 사용자 확인 요청
4. 개인 키로 트랜잭션 서명
5. 트랜잭션 네트워크에 브로드캐스트
6. 트랜잭션 상태 모니터링 및 UI 업데이트

### 2.3 dApp 연결 프로세스

1. dApp에서 지갑 연결 요청
2. 콘텐츠 스크립트가 요청을 팝업으로 전달
3. 사용자 확인 요청
4. 승인 시 지갑 계정 정보 dApp에 공유
5. dApp에서 발생하는 트랜잭션 요청은 위의 트랜잭션 프로세스 따름

### 2.4 크로스체인 전송 프로세스

1. 사용자가 크로스체인 전송 요청
2. 소스 체인에서 트랜잭션 생성 및 서명
3. 소스 체인에 트랜잭션 브로드캐스트
4. 크로스체인 릴레이어가 소스 체인의 트랜잭션 감지
5. 크로스체인 릴레이어가 대상 체인에 상응하는 트랜잭션 생성
6. 대상 체인에 트랜잭션 브로드캐스트
7. 트랜잭션 상태 모니터링 및 UI 업데이트

## 3. 보안 아키텍처

TORI 지갑은 사용자 자산의 안전을 최우선으로 고려한 보안 아키텍처를 갖추고 있습니다.

### 3.1 키 관리

- **개인 키 저장**: 개인 키는 절대로 서버에 저장되지 않으며, 사용자의 기기에 암호화되어 저장됩니다.
- **암호화**: AES-256 암호화를 사용하여 개인 키 암호화
- **암호 보호**: 사용자 암호를 사용하여 개인 키에 대한 접근 제한
- **니모닉 백업**: BIP-39 표준을 따르는 니모닉 시드 구문 사용
- **하드웨어 지갑 통합**: Ledger, Trezor 등 하드웨어 지갑 지원

### 3.2 인증 및 승인

- **생체 인증**: 지문 인식, Face ID 등 모바일 기기의 생체 인증 기능 통합
- **2단계 인증(2FA)**: TOTP(Time-based One-Time Password) 기반 2FA 지원
- **트랜잭션 확인**: 모든 트랜잭션은 사용자의 명시적인 확인 필요
- **자동 잠금**: 일정 시간 동안 활동이 없을 경우 자동 잠금 기능

### 3.3 사회적 복구

- **Shamir's Secret Sharing**: 개인 키를 여러 조각으로 나누어 신뢰할 수 있는 친구나 가족에게 분산
- **복구 프로세스**: 일정 수 이상의 조각을 모으면 개인 키 복구 가능

### 3.4 멀티시그 지갑

- **다중 서명 요구**: 트랜잭션 실행에 여러 개의 서명 필요
- **권한 수준**: 트랜잭션 유형 및 금액에 따른 서명 요구 사항 설정

### 3.5 네트워크 보안

- **안전한 연결**: HTTPS 및 SSL/TLS 암호화 사용
- **API 보안**: 모든 API 요청에 대한 인증 및 권한 검사
- **제한된 접근**: 필요한 API에만 접근하도록 제한

### 3.6 코드 보안

- **코드 감사**: 정기적인 코드 감사 및 보안 검토
- **의존성 검사**: 외부 라이브러리 및 의존성에 대한 보안 취약점 검사
- **자동화된 테스트**: 보안 관련 자동화 테스트 구현

## 4. 크로스체인 아키텍처

TORI 지갑은 다양한 블록체인 네트워크 간의 자산 이동을 지원하는 크로스체인 아키텍처를 갖추고 있습니다.

### 4.1 ICP 릴레이어

ICP(Inter-Chain Protocol) 릴레이어는 CreataChain 생태계 내에서 Zenith Chain과 Catena Chain 간의 자산 이동을 담당합니다.

- **릴레이 노드**: 양쪽 체인의 트랜잭션을 모니터링하고 상호 작용하는 노드
- **트랜잭션 검증**: 소스 체인의 트랜잭션 유효성 검증
- **크로스체인 트랜잭션**: 대상 체인에 상응하는 트랜잭션 생성
- **상태 동기화**: 양쪽 체인의 상태 동기화

### 4.2 외부 브릿지

외부 브릿지는 CreataChain 생태계와 외부 블록체인(이더리움, 바이낸스 스마트 체인, 폴리곤, 솔라나 등) 간의 자산 이동을 담당합니다.

- **브릿지 계약**: 각 체인에 배포된 스마트 계약
- **스마트 계약 세트**: 자산 잠금, 증명, 해제 등을 처리하는 스마트 계약 세트
- **검증자 세트**: 트랜잭션 유효성을 검증하는 검증자 노드
- **오라클 통합**: 체인 간 데이터 전달을 위한 오라클 서비스

### 4.3 크로스체인 스왑

크로스체인 스왑은 서로 다른 블록체인의 토큰을 직접 교환할 수 있는 기능을 제공합니다.

- **유동성 풀**: 크로스체인 스왑을 위한 유동성 풀
- **라우팅 알고리즘**: 최적의 스왑 경로를 찾는 알고리즘
- **가격 예측**: 슬리피지 및 최종 가격 예측
- **트랜잭션 실행**: 소스 체인 및 대상 체인에서의 트랜잭션 실행

## 5. 스테이킹 및 DeFi 아키텍처

TORI 지갑은 스테이킹 및 DeFi 기능을 지원하는 아키텍처를 갖추고 있습니다.

### 5.1 스테이킹

- **검증자 관리**: 검증자 목록 및 상태 관리
- **위임 관리**: 사용자의 스테이킹 위임 관리
- **보상 계산**: 스테이킹 보상 계산 및 청구
- **자동 복리**: 스테이킹 보상 자동 재투자 기능

### 5.2 DeFi 통합

- **프로토콜 통합**: 다양한 DeFi 프로토콜과의 통합
- **포지션 관리**: 사용자의 DeFi 포지션 관리
- **수익률 계산**: DeFi 포지션의 수익률 계산
- **위험 분석**: DeFi 포지션의 위험 분석

## 6. 다국어 지원 아키텍처

TORI 지갑은 다양한 언어를 지원하는 다국어 아키텍처를 갖추고 있습니다.

### 6.1 번역 관리

- **JSON 형식**: 언어별 번역을 JSON 형식으로 관리
- **동적 로딩**: 필요한 언어 파일만 동적으로 로드
- **폴백 메커니즘**: 번역이 없는 경우 기본 언어(영어)로 폴백

### 6.2 지원 언어

- 영어 (기본)
- 한국어
- 일본어
- 중국어 (간체 및 번체)
- 베트남어
- 태국어

## 7. 플러그인 아키텍처

TORI 지갑은 플러그인을 통해 기능을 확장할 수 있는 아키텍처를 갖추고 있습니다.

### 7.1 플러그인 시스템

- **플러그인 인터페이스**: 플러그인 개발을 위한 표준 인터페이스
- **플러그인 관리**: 플러그인 설치, 업데이트, 제거 관리
- **권한 관리**: 플러그인의 권한 관리

### 7.2 플러그인 예시

- **시장 데이터 플러그인**: 실시간 시장 데이터 제공
- **포트폴리오 분석 플러그인**: 포트폴리오 분석 및 시각화
- **세금 보고서 플러그인**: 세금 보고서 생성
- **소셜 트레이딩 플러그인**: 다른 사용자의 트레이딩 전략 공유

## 8. 확장성 및 성능 최적화

TORI 지갑은 확장성 및 성능을 최적화하기 위한 아키텍처를 갖추고 있습니다.

### 8.1 코드 분할

- **동적 임포트**: 필요한 모듈만 동적으로 로드
- **번들 분석**: 번들 크기 분석 및 최적화
- **트리 셰이킹**: 사용하지 않는 코드 제거

### 8.2 캐싱

- **로컬 캐싱**: 자주 사용하는 데이터 로컬 캐싱
- **메모이제이션**: 반복 계산 방지를 위한 메모이제이션
- **지연 로딩**: 필요한 시점에 데이터 로드

### 8.3 병렬 처리

- **워커 스레드**: 복잡한 계산 워커 스레드로 분리
- **병렬 요청**: 독립적인 API 요청 병렬 처리
- **비동기 처리**: 비동기 처리를 통한 UI 반응성 유지

## 9. 테스트 아키텍처

TORI 지갑은 신뢰성을 보장하기 위한 테스트 아키텍처를 갖추고 있습니다.

### 9.1 단위 테스트

- **서비스 테스트**: 핵심 서비스의 단위 테스트
- **유틸리티 테스트**: 유틸리티 함수의 단위 테스트
- **모킹**: 외부 의존성 모킹

### 9.2 통합 테스트

- **서비스 간 테스트**: 여러 서비스 간의 통합 테스트
- **API 테스트**: 외부 API 통합 테스트
- **상태 관리 테스트**: 상태 관리 시스템 테스트

### 9.3 엔드투엔드 테스트

- **사용자 흐름 테스트**: 주요 사용자 흐름 테스트
- **크로스 플랫폼 테스트**: 여러 플랫폼에서의 테스트
- **회귀 테스트**: 기존 기능 회귀 테스트

## 10. 배포 아키텍처

TORI 지갑은 안정적인 배포를 위한 배포 아키텍처를 갖추고 있습니다.

### 10.1 CI/CD 파이프라인

- **자동화된 빌드**: 코드 변경 시 자동 빌드
- **자동화된 테스트**: 빌드 후 자동 테스트
- **자동화된 배포**: 테스트 통과 시 자동 배포

### 10.2 버전 관리

- **시맨틱 버전닝**: 표준 시맨틱 버전닝 체계 사용
- **변경 로그**: 자동 생성된 변경 로그
- **롤백 메커니즘**: 문제 발생 시 롤백

### 10.3 환경 분리

- **개발 환경**: 개발 및 테스트를 위한 환경
- **스테이징 환경**: 배포 전 검증을 위한 환경
- **프로덕션 환경**: 실제 사용자를 위한 환경

## 11. 핵심 컴포넌트

### Core 패키지

Core 패키지는 TORI 지갑의 핵심 기능을 제공하며, 다른 모든 패키지에서 재사용됩니다.

#### 주요 모듈

1. **Crypto 서비스**
   - `keyring.ts`: 키 관리 서비스
   - `mnemonic.ts`: 니모닉 시드 관리
   - `hdkey.ts`: HD 키 파생
   - `encryption.ts`: 암호화 및 복호화
   - `signature.ts`: 트랜잭션 서명

2. **Storage 서비스**
   - `local.ts`: 로컬 스토리지 관리
   - `secure.ts`: 보안 스토리지 관리
   - `sync.ts`: 데이터 동기화 관리

3. **Transaction 서비스**
   - `builder.ts`: 트랜잭션 생성
   - `signer.ts`: 트랜잭션 서명
   - `sender.ts`: 트랜잭션 전송
   - `gas.ts`: 가스 계산 및 추정

4. **Crosschain 서비스**
   - `relayer.ts`: ICP 릴레이어 서비스
   - `bridge.ts`: 크로스체인 브릿지 서비스
   - `swap.ts`: 크로스체인 스왑 서비스

5. **Network 서비스**
   - 각 지원 네트워크별 API 모듈
   - 네트워크 상태 모니터링
   - RPC 요청 처리

### Extension 패키지

브라우저 확장 프로그램은 다음과 같은 주요 구성 요소로 이루어져 있습니다:

1. **Background 스크립트**
   - 확장 프로그램의 메인 프로세스
   - 지갑 상태 관리 및 영구 저장
   - 백그라운드 작업 처리

2. **Content 스크립트**
   - 웹페이지와 확장 프로그램 간의 브릿지
   - 웹페이지에 웹3 프로바이더 주입

3. **Inpage 스크립트**
   - 웹페이지에 주입되는 웹3 프로바이더
   - dApp과의 통신 처리

4. **Popup UI**
   - 사용자 인터페이스 구현
   - 지갑 관리, 트랜잭션 서명 등

5. **dApp 브라우저**
   - 확장 프로그램 내 웹3 브라우저
   - dApp과 직접 통합

### Mobile 패키지

모바일 앱은 React Native를 사용하여 구현되며, 다음과 같은 주요 구성 요소를 포함합니다:

1. **화면 및 컴포넌트**
   - 모든 화면 및 UI 컴포넌트
   - 반응형 디자인

2. **네이티브 모듈**
   - 생체 인증
   - 푸시 알림
   - QR 코드 스캔
   - 딥 링크 처리

3. **네비게이션**
   - 앱의 화면 이동 및 라우팅 구성

### Desktop 패키지

데스크톱 앱은 Electron을 사용하여 구현되며, 다음과 같은 주요 구성 요소를 포함합니다:

1. **Main 프로세스**
   - 앱 라이프사이클 관리
   - 윈도우 관리
   - 시스템 통합

2. **Renderer 프로세스**
   - UI 렌더링
   - 사용자 상호작용 처리

3. **IPC 통신**
   - Main 프로세스와 Renderer 프로세스 간의 통신

### Telegram 패키지

텔레그램 미니앱은 웹 기반으로 구현되며, 다음과 같은 주요 구성 요소를 포함합니다:

1. **텔레그램 API 통합**
   - 텔레그램 WebApp API 사용
   - 텔레그램 사용자 인증

2. **UI 컴포넌트**
   - 텔레그램 UI 가이드라인에 맞는 컴포넌트

3. **P2P 송금 기능**
   - 텔레그램 사용자 간 송금 처리

## 12. 데이터 흐름

### 지갑 생성 및 복구 흐름

1. 사용자가 새 지갑 생성 또는 복구 요청
2. Core의 Crypto 서비스에서 니모닉 시드 생성 또는 검증
3. HD 키 파생 및 계정 생성
4. 암호화된 형태로 키 저장 (Storage 서비스 사용)
5. 사용자에게 지갑 대시보드 표시

### 트랜잭션 처리 흐름

1. 사용자가 트랜잭션 요청
2. Transaction 서비스에서 트랜잭션 객체 생성
3. 가스비 추정 및 사용자 확인
4. 사용자 승인 후 개인 키로 트랜잭션 서명
5. 서명된 트랜잭션을 네트워크에 전송
6. 트랜잭션 결과 모니터링 및 상태 업데이트

### dApp 연결 흐름

1. 사용자가 dApp 방문
2. dApp이 지갑 연결 요청
3. Content 스크립트가 요청을 Background 스크립트로 전달
4. Background 스크립트가 연결 요청 팝업 표시
5. 사용자가 승인하면 dApp에 계정 정보 제공
6. dApp이 트랜잭션 요청 시 사용자 승인 후 처리

### 크로스체인 트랜잭션 흐름

1. 사용자가 크로스체인 전송 요청
2. Crosschain 서비스에서 소스 체인 트랜잭션 준비
3. 사용자 승인 후 소스 체인 트랜잭션 전송
4. ICP 릴레이어가 트랜잭션 모니터링
5. 대상 체인에 상응하는 트랜잭션 실행
6. 전체 크로스체인 트랜잭션 상태 업데이트

## 13. 보안 아키텍처

TORI 지갑은 다음과 같은 보안 원칙을 따릅니다:

1. **개인 키 보호**
   - 개인 키는 항상 사용자 기기에 암호화된 형태로 저장
   - 개인 키는 절대 서버로 전송되지 않음
   - 메모리에서 사용하지 않을 때는 안전하게 제거

2. **멀티 레이어 보안**
   - 암호 보호: 지갑 접근 시 암호 요구
   - 생체 인증: 지원 기기에서 생체 인증 통합
   - 2FA: 선택적 2단계 인증 지원
   - 자동 잠금: 일정 시간 후 자동 잠금

3. **트랜잭션 보안**
   - 모든 트랜잭션은 사용자 명시적 승인 필요
   - 트랜잭션 세부 정보를 명확하게 표시
   - 이상 거래 탐지 및 경고

4. **dApp 연결 보안**
   - 권한 기반 접근 제어
   - 연결된 dApp 및 권한 관리
   - 악성 dApp 탐지 및 차단

5. **네트워크 보안**
   - 모든 통신은 HTTPS 사용
   - 인증서 핀닝 구현
   - API 요청 서명 및 검증

## 14. 플랫폼별 특수 고려사항

### 브라우저 확장 프로그램
- 백그라운드/콘텐츠/인페이지 스크립트 간 통신 최적화
- 브라우저 권한 관리
- 웹페이지와 안전한 통합

### 모바일 앱
- 네이티브 기능 활용 (생체 인증, 카메라, 푸시 알림 등)
- 오프라인 사용성 최적화
- 배터리 및 데이터 사용량 최적화

### 데스크톱 앱
- 다양한 OS 지원 (Windows, macOS, Linux)
- 자동 업데이트 메커니즘
- 시스템 트레이 통합

### 텔레그램 미니앱
- 텔레그램 API 제한 사항 고려
- 텔레그램 사용자 경험과 일관성 유지
- 채팅 기반 명령어 지원

## 15. 결론

TORI 지갑 아키텍처는 확장성, 유지 관리성, 보안을 모두 고려한 설계로, CreataChain 생태계와 다양한 블록체인 네트워크를 지원하는 멀티체인 암호화폐 지갑 제공을 목표로 합니다. 모듈형 설계와 코드 재사용을 통해 다양한 플랫폼에서 일관된 사용자 경험을 제공하면서도 각 플랫폼의 특성을 최대한 활용할 수 있도록 구성되어 있습니다.

## 추가 자료

- [코어 아키텍처](core.md)
- [보안 아키텍처](security.md)
- [크로스체인 아키텍처](crosschain_part1.md)
- [API 문서](../api/core.md)